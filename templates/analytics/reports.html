{% extends "layouts/admin_layout.html" %}

{% block title %}Reports - AI Career Platform{% endblock %}

{% block admin_content %}
<!-- Reports Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1">Reports & Analytics</h2>
        <p class="text-muted mb-0">Generate comprehensive reports for placement analysis</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="testEmailConfiguration()">
            <i class="bi bi-envelope-check me-1"></i>Test Email
        </button>
        <button class="btn btn-outline-primary" onclick="viewReportHistory()">
            <i class="bi bi-clock-history me-1"></i>Report History
        </button>
        <button class="btn btn-primary" onclick="generateQuickReport()">
            <i class="bi bi-lightning me-1"></i>Quick Report
        </button>
    </div>
</div>

<!-- Report Types -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card report-type-card h-100" onclick="selectReportType('placement_summary')">
            <div class="card-body text-center">
                <div class="report-icon mb-3">
                    <i class="bi bi-briefcase text-primary" style="font-size: 3rem;"></i>
                </div>
                <h5 class="fw-bold">Placement Summary</h5>
                <p class="text-muted">Overall placement statistics and trends</p>
                <div class="report-features">
                    <small class="text-muted">
                        • Branch-wise analysis<br>
                        • Salary statistics<br>
                        • Industry distribution
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card report-type-card h-100" onclick="selectReportType('skill_gap_analysis')">
            <div class="card-body text-center">
                <div class="report-icon mb-3">
                    <i class="bi bi-graph-up text-success" style="font-size: 3rem;"></i>
                </div>
                <h5 class="fw-bold">Skill Gap Analysis</h5>
                <p class="text-muted">Department-wise skill gap analysis</p>
                <div class="report-features">
                    <small class="text-muted">
                        • Missing skills identification<br>
                        • Industry demand mapping<br>
                        • Curriculum recommendations
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card report-type-card h-100" onclick="selectReportType('industry_demand')">
            <div class="card-body text-center">
                <div class="report-icon mb-3">
                    <i class="bi bi-building text-warning" style="font-size: 3rem;"></i>
                </div>
                <h5 class="fw-bold">Industry Demand</h5>
                <p class="text-muted">Current industry skill demand trends</p>
                <div class="report-features">
                    <small class="text-muted">
                        • Trending skills<br>
                        • Salary benchmarks<br>
                        • Market forecasts
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card report-type-card h-100" onclick="selectReportType('branch_performance')">
            <div class="card-body text-center">
                <div class="report-icon mb-3">
                    <i class="bi bi-trophy text-info" style="font-size: 3rem;"></i>
                </div>
                <h5 class="fw-bold">Branch Performance</h5>
                <p class="text-muted">Branch-wise placement performance</p>
                <div class="report-features">
                    <small class="text-muted">
                        • Placement rates<br>
                        • Performance comparison<br>
                        • Improvement suggestions
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Configuration -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Report Configuration</h5>
            </div>
            <div class="card-body">
                <form id="report-config-form">
                    <!-- Report Type Selection -->
                    <div class="mb-4">
                        <label class="form-label">Report Type *</label>
                        <select class="form-select" id="report-type" name="report_type" required>
                            <option value="">Select Report Type</option>
                            <option value="placement_summary">Placement Summary Report</option>
                            <option value="skill_gap_analysis">Skill Gap Analysis Report</option>
                            <option value="industry_demand">Industry Demand Report</option>
                            <option value="branch_performance">Branch Performance Report</option>
                        </select>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="start-date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start-date" name="start_date">
                        </div>
                        <div class="col-md-6">
                            <label for="end-date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end-date" name="end_date">
                        </div>
                    </div>
                    
                    <!-- Quick Date Range Buttons -->
                    <div class="mb-4">
                        <label class="form-label">Quick Date Ranges</label>
                        <div class="btn-group d-flex" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="setQuickDate('current_year')">Current Year</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setQuickDate('last_year')">Last Year</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setQuickDate('last_6_months')">Last 6 Months</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setQuickDate('last_3_months')">Last 3 Months</button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="mb-4" id="report-filters">
                        <label class="form-label">Filters</label>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="branch-filter" class="form-label">Branch</label>
                                <select class="form-select" id="branch-filter" name="branch">
                                    <option value="">All Branches</option>
                                    <option value="Computer Science Engineering">Computer Science Engineering</option>
                                    <option value="Information Technology">Information Technology</option>
                                    <option value="Electronics & Communication">Electronics & Communication</option>
                                    <option value="Electrical Engineering">Electrical Engineering</option>
                                    <option value="Mechanical Engineering">Mechanical Engineering</option>
                                    <option value="Civil Engineering">Civil Engineering</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="industry-filter" class="form-label">Industry</label>
                                <select class="form-select" id="industry-filter" name="industry">
                                    <option value="">All Industries</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Consulting">Consulting</option>
                                    <option value="Education">Education</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export Format -->
                    <div class="mb-4">
                        <label class="form-label">Export Format *</label>
                        <div class="btn-group d-flex" role="group">
                            <input type="radio" class="btn-check" name="format" id="format-pdf" value="pdf">
                            <label class="btn btn-outline-primary" for="format-pdf">
                                <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                            </label>
                            
                            <input type="radio" class="btn-check" name="format" id="format-csv" value="csv">
                            <label class="btn btn-outline-primary" for="format-csv">
                                <i class="bi bi-file-earmark-spreadsheet me-1"></i>CSV
                            </label>
                            
                            <input type="radio" class="btn-check" name="format" id="format-json" value="json" checked>
                            <label class="btn btn-outline-primary" for="format-json">
                                <i class="bi bi-file-earmark-code me-1"></i>JSON
                            </label>
                        </div>
                    </div>
                    
                    <!-- Advanced Options -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include-charts" name="include_charts" checked>
                            <label class="form-check-label" for="include-charts">
                                Include charts and visualizations
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include-raw-data" name="include_raw_data">
                            <label class="form-check-label" for="include-raw-data">
                                Include raw data tables
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email-report" name="email_report">
                            <label class="form-check-label" for="email-report">
                                Email report when ready
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="schedule-report" name="schedule_report">
                            <label class="form-check-label" for="schedule-report">
                                Schedule automated delivery
                            </label>
                        </div>
                    </div>
                    
                    <!-- Email Configuration (hidden by default) -->
                    <div class="mb-4" id="email-config" style="display: none;">
                        <label class="form-label">Email Recipients *</label>
                        <textarea class="form-control" id="email-recipients" name="email_recipients" 
                                  placeholder="Enter email addresses separated by commas or new lines" rows="3"></textarea>
                        <small class="text-muted">Enter one email per line or separate with commas</small>
                        
                        <div class="mt-3">
                            <label for="email-subject" class="form-label">Email Subject</label>
                            <input type="text" class="form-control" id="email-subject" name="email_subject" 
                                   placeholder="Auto-generated if left blank">
                        </div>
                    </div>
                    
                    <!-- Schedule Configuration (hidden by default) -->
                    <div class="mb-4" id="schedule-config" style="display: none;">
                        <label class="form-label">Schedule Type</label>
                        <select class="form-select" id="schedule-type" name="schedule_type">
                            <option value="once">Send Once (Immediate)</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Scheduled reports will be sent automatically based on the selected frequency.
                            </small>
                        </div>
                    </div>
                    
                    <!-- Generate Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="generate-btn">
                            <i class="bi bi-file-earmark-text me-2"></i>Generate Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Report Preview & History -->
    <div class="col-lg-4">
        <!-- Report Preview -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-eye me-2"></i>Report Preview</h6>
            </div>
            <div class="card-body">
                <div id="report-preview">
                    <div class="text-center py-4">
                        <i class="bi bi-file-earmark text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">Select a report type to see preview</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Reports -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Reports</h6>
            </div>
            <div class="card-body">
                <div id="recent-reports">
                    <div class="report-history-item mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold">Placement Summary</div>
                                <small class="text-muted">Generated 2 hours ago</small>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-download me-2"></i>Download</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-share me-2"></i>Share</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-success">PDF</span>
                            <span class="badge bg-light text-dark">2024 Data</span>
                        </div>
                    </div>
                    
                    <div class="report-history-item mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold">Skill Gap Analysis</div>
                                <small class="text-muted">Generated yesterday</small>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-download me-2"></i>Download</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-share me-2"></i>Share</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-info">CSV</span>
                            <span class="badge bg-light text-dark">CSE Branch</span>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewReportHistory()">
                            View All Reports
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Generation Progress Modal -->
<div class="modal fade" id="reportProgressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generating Report</h5>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="loading-spinner mb-3"></div>
                    <h6 id="progress-title">Preparing report...</h6>
                    <p class="text-muted" id="progress-description">This may take a few moments</p>
                    
                    <div class="progress mt-3">
                        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted mt-2" id="progress-text">0% complete</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.report-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.report-type-card:hover {
    border-color: var(--primary-blue);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    transform: translateY(-2px);
}

.report-type-card.selected {
    border-color: var(--primary-blue);
    background: rgba(37, 99, 235, 0.05);
}

.report-icon {
    transition: transform 0.3s ease;
}

.report-type-card:hover .report-icon {
    transform: scale(1.1);
}

.report-features {
    text-align: left;
    margin-top: 1rem;
}

.report-history-item {
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-color);
}

.report-history-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.progress {
    height: 8px;
    border-radius: 4px;
}

.progress-bar {
    transition: width 0.3s ease;
}

#report-preview {
    min-height: 200px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    background: var(--light-grey);
}

.preview-section {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: var(--white);
    border-radius: 6px;
    border-left: 3px solid var(--primary-blue);
}

.preview-title {
    font-weight: 600;
    color: var(--primary-blue);
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Reports JavaScript
let selectedReportType = '';

document.addEventListener('DOMContentLoaded', function() {
    setupFormHandlers();
    setDefaultDates();
});

function setupFormHandlers() {
    // Form submission
    document.getElementById('report-config-form').addEventListener('submit', function(e) {
        e.preventDefault();
        generateReport();
    });
    
    // Report type selection
    document.getElementById('report-type').addEventListener('change', function() {
        selectedReportType = this.value;
        updateReportPreview();
    });
    
    // Email report checkbox
    document.getElementById('email-report').addEventListener('change', function() {
        const emailConfig = document.getElementById('email-config');
        emailConfig.style.display = this.checked ? 'block' : 'none';
        
        // Make email recipients required if email is enabled
        const emailRecipientsField = document.getElementById('email-recipients');
        emailRecipientsField.required = this.checked;
    });
    
    // Schedule report checkbox
    document.getElementById('schedule-report').addEventListener('change', function() {
        const scheduleConfig = document.getElementById('schedule-config');
        scheduleConfig.style.display = this.checked ? 'block' : 'none';
        
        // Auto-enable email when scheduling is enabled
        if (this.checked) {
            document.getElementById('email-report').checked = true;
            document.getElementById('email-config').style.display = 'block';
            document.getElementById('email-recipients').required = true;
        }
    });
}

function setDefaultDates() {
    // Set default to current year
    const currentYear = new Date().getFullYear();
    document.getElementById('start-date').value = `${currentYear}-01-01`;
    document.getElementById('end-date').value = `${currentYear}-12-31`;
}

function selectReportType(type) {
    // Update visual selection
    document.querySelectorAll('.report-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    // Update form
    document.getElementById('report-type').value = type;
    selectedReportType = type;
    updateReportPreview();
}

function updateReportPreview() {
    const previewContainer = document.getElementById('report-preview');
    
    if (!selectedReportType) {
        previewContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-file-earmark text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">Select a report type to see preview</p>
            </div>
        `;
        return;
    }
    
    const previews = {
        placement_summary: {
            title: 'Placement Summary Report',
            sections: [
                'Executive Summary',
                'Overall Statistics',
                'Branch-wise Analysis',
                'Industry Distribution',
                'Salary Analysis',
                'Trends & Forecasts'
            ]
        },
        skill_gap_analysis: {
            title: 'Skill Gap Analysis Report',
            sections: [
                'Current Skill Inventory',
                'Industry Demand Analysis',
                'Gap Identification',
                'Branch-wise Gaps',
                'Recommendations',
                'Action Plan'
            ]
        },
        industry_demand: {
            title: 'Industry Demand Report',
            sections: [
                'Market Overview',
                'Top Skills in Demand',
                'Trending Technologies',
                'Salary Benchmarks',
                'Future Projections',
                'Career Opportunities'
            ]
        },
        branch_performance: {
            title: 'Branch Performance Report',
            sections: [
                'Performance Overview',
                'Placement Rates',
                'Comparative Analysis',
                'Success Factors',
                'Improvement Areas',
                'Recommendations'
            ]
        }
    };
    
    const preview = previews[selectedReportType];
    
    previewContainer.innerHTML = `
        <div class="preview-header mb-3">
            <h6 class="fw-bold text-primary">${preview.title}</h6>
            <small class="text-muted">Report sections preview</small>
        </div>
        ${preview.sections.map(section => 
            `<div class="preview-section">
                <div class="preview-title">${section}</div>
                <small class="text-muted">Detailed analysis and insights</small>
            </div>`
        ).join('')}
    `;
}

function setQuickDate(range) {
    const today = new Date();
    let startDate, endDate;
    
    switch (range) {
        case 'current_year':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            break;
        case 'last_year':
            startDate = new Date(today.getFullYear() - 1, 0, 1);
            endDate = new Date(today.getFullYear() - 1, 11, 31);
            break;
        case 'last_6_months':
            startDate = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate());
            endDate = today;
            break;
        case 'last_3_months':
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
            endDate = today;
            break;
    }
    
    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

async function generateReport() {
    try {
        const formData = new FormData(document.getElementById('report-config-form'));
        const data = Object.fromEntries(formData.entries());
        
        // Validate required fields
        if (!data.report_type) {
            CP.utils.showToast('Please select a report type', 'warning');
            return;
        }
        
        if (!data.format) {
            CP.utils.showToast('Please select an export format', 'warning');
            return;
        }
        
        // Show progress modal
        showReportProgress();
        
        // Parse email recipients if provided
        let emailRecipients = [];
        if (data.email_recipients) {
            emailRecipients = data.email_recipients
                .split(/[,\n]/)
                .map(email => email.trim())
                .filter(email => email.length > 0);
        }
        
        // Prepare request data
        const requestData = {
            report_type: data.report_type,
            format: data.format,
            start_date: data.start_date,
            end_date: data.end_date,
            filters: {
                branch: data.branch,
                industry: data.industry
            },
            options: {
                include_charts: data.include_charts === 'on',
                include_raw_data: data.include_raw_data === 'on',
                email_report: data.email_report === 'on',
                schedule_report: data.schedule_report === 'on'
            },
            recipients: emailRecipients,
            subject: data.email_subject,
            schedule_type: data.schedule_type || 'once'
        };
        
        // Check if email delivery is requested
        if (data.email_report === 'on' && emailRecipients.length > 0) {
            // Handle email delivery
            if (data.schedule_report === 'on') {
                // Schedule report delivery
                updateProgress(60, 'Scheduling report...', 'Setting up automated delivery');
                
                const response = await CP.api.post('/analytics/reports/schedule', requestData);
                
                if (response.success) {
                    updateProgress(100, 'Report scheduled!', response.message);
                    
                    setTimeout(() => {
                        hideReportProgress();
                        CP.utils.showToast(response.message, 'success');
                    }, 1000);
                }
            } else {
                // Send email immediately
                updateProgress(60, 'Sending email...', 'Delivering report to recipients');
                
                const response = await CP.api.post('/analytics/reports/email', requestData);
                
                if (response.success) {
                    updateProgress(100, 'Email sent!', response.message);
                    
                    setTimeout(() => {
                        hideReportProgress();
                        CP.utils.showToast(response.message, 'success');
                    }, 1000);
                }
            }
        } else {
            // Generate report for download
            if (data.format === 'json') {
                const response = await CP.api.post('/analytics/reports', requestData);
                
                if (response.success) {
                    updateProgress(100, 'Report generated successfully!', 'Your report is ready for download');
                    
                    setTimeout(() => {
                        hideReportProgress();
                        downloadJsonReport(response.data, data.report_type);
                    }, 1000);
                }
            } else {
                // For PDF and CSV, use the export endpoint
                const exportUrl = `/analytics/reports/export/${data.report_type}/${data.format}`;
                
                updateProgress(80, 'Generating file...', 'Creating downloadable document');
                
                const response = await fetch(exportUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    updateProgress(100, 'Download ready!', 'Starting download...');
                    
                    // Get filename from response headers or create default
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = `${data.report_type}_${new Date().toISOString().split('T')[0]}.${data.format}`;
                    
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }
                    
                    // Download the file
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    setTimeout(() => {
                        hideReportProgress();
                        CP.utils.showToast(`${data.format.toUpperCase()} report downloaded successfully!`, 'success');
                    }, 1000);
                } else {
                    throw new Error(`Export failed: ${response.statusText}`);
                }
            }
        }
        
    } catch (error) {
        console.error('Error generating report:', error);
        hideReportProgress();
        CP.utils.showToast('Failed to generate report', 'error');
    }
}

function showReportProgress() {
    const modal = new bootstrap.Modal(document.getElementById('reportProgressModal'));
    modal.show();
    
    // Simulate progress
    let progress = 0;
    const progressSteps = [
        { progress: 20, title: 'Collecting data...', description: 'Gathering placement and student data' },
        { progress: 40, title: 'Analyzing trends...', description: 'Processing analytics and calculations' },
        { progress: 60, title: 'Generating insights...', description: 'Creating visualizations and summaries' },
        { progress: 80, title: 'Formatting report...', description: 'Preparing final document' },
        { progress: 100, title: 'Complete!', description: 'Report is ready' }
    ];
    
    let stepIndex = 0;
    const interval = setInterval(() => {
        if (stepIndex < progressSteps.length) {
            const step = progressSteps[stepIndex];
            updateProgress(step.progress, step.title, step.description);
            stepIndex++;
        } else {
            clearInterval(interval);
        }
    }, 800);
}

function updateProgress(percentage, title, description) {
    document.getElementById('progress-bar').style.width = percentage + '%';
    document.getElementById('progress-text').textContent = percentage + '% complete';
    document.getElementById('progress-title').textContent = title;
    document.getElementById('progress-description').textContent = description;
}

function hideReportProgress() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('reportProgressModal'));
    if (modal) {
        modal.hide();
    }
}

function downloadJsonReport(data, reportType) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${reportType}_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function generateQuickReport() {
    // Set default values for quick report
    document.getElementById('report-type').value = 'placement_summary';
    document.getElementById('format-json').checked = true;
    selectedReportType = 'placement_summary';
    updateReportPreview();
    
    // Generate immediately
    generateReport();
}

function viewReportHistory() {
    CP.utils.showToast('Report history feature coming soon!', 'info');
}

async function testEmailConfiguration() {
    try {
        const response = await CP.api.post('/analytics/email/test');
        
        if (response.success) {
            CP.utils.showToast('Email configuration is working correctly!', 'success');
        } else {
            CP.utils.showToast(`Email configuration error: ${response.error}`, 'error');
        }
    } catch (error) {
        CP.utils.showToast('Failed to test email configuration', 'error');
    }
}

function validateEmailRecipients(emailString) {
    if (!emailString) return [];
    
    const emails = emailString
        .split(/[,\n]/)
        .map(email => email.trim())
        .filter(email => email.length > 0);
    
    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    const invalidEmails = emails.filter(email => !emailPattern.test(email));
    
    if (invalidEmails.length > 0) {
        CP.utils.showToast(`Invalid email addresses: ${invalidEmails.join(', ')}`, 'warning');
        return null;
    }
    
    return emails;
}
</script>
{% endblock %}